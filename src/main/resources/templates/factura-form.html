<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Nueva Factura</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h1>Crear Nueva Factura</h1>

<form th:action="@{/facturas/guardar}" method="post" th:object="${factura}">

  <label>Fecha de Venta:</label>
  <input type="date" th:field="*{fechaVenta}" required><br>

  <label>Descripción de la Venta:</label>
  <input type="text" th:field="*{descripcionVenta}" required><br>

  <label>Usuario:</label>
  <select th:field="*{usuario.documento}">
    <option value="">Seleccione usuario</option>
    <option th:each="u : ${usuarios}" th:value="${u.documento}" th:text="${u.nombreCompleto}"></option>
  </select><br>

  <label>Empresa:</label>
  <select th:field="*{empresa.nitEmpresa}">
    <option value="">Seleccione empresa</option>
    <option th:each="e : ${empresas}" th:value="${e.nitEmpresa}" th:text="${e.nombre}"></option>
  </select><br>

  <label>Ciudad:</label>
  <select th:field="*{ciudad.id}">
    <option value="">Seleccione ciudad</option>
    <option th:each="c : ${ciudades}" th:value="${c.id}" th:text="${c.nombre}"></option>
  </select><br><br>

  <h3>Detalles de la Factura</h3>

  <div th:each="i : ${#numbers.sequence(0,2)}">
    <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
      <label>Producto:</label>
      <select name="productoId" class="producto-select" th:data-index="${i}" th:id="'producto-select-' + ${i}">
        <option value="">Seleccione un producto</option>
        <option th:each="p : ${productos}"
                th:value="${p.id}"
                th:text="${p.nombre}"
                th:data-nombre="${p.nombre}"></option>
      </select><br><br>

      <label>Terminado:</label>
      <select name="terminadoId" class="terminado-select" th:data-index="${i}" th:id="'terminado-select-' + ${i}" disabled>
        <option value="">Primero seleccione un producto</option>
      </select><br><br>

      <label>Cantidad:</label>
      <input type="number" name="cantidad" min="1" required th:id="'cantidad-' + ${i}"><br><br>

      <label>Valor:</label>
      <input type="number" name="valor" step="0.01" required th:id="'valor-' + ${i}"><br><br>

      <label>Descripción:</label>
      <input type="text" name="descripcion" class="descripcion-input" th:data-index="${i}" th:id="'descripcion-' + ${i}" readonly>
    </div>
  </div>

  <button type="submit">Guardar Factura</button>
</form>

<script>
$(document).ready(function() {
    console.log("JavaScript cargado correctamente");

    $(document).on('change', '.producto-select', function() {
        var $this = $(this);
        var productoId = $this.val();
        var index = $this.data('index');
        var productoNombre = $this.find('option:selected').data('nombre');
        var $terminadoSelect = $('#terminado-select-' + index);
        var $descripcionInput = $('#descripcion-' + index);

        console.log("Producto seleccionado - ID:", productoId, "Index:", index, "Nombre:", productoNombre);

        $terminadoSelect.prop('disabled', true);
        $terminadoSelect.empty().append('<option value="">Cargando terminados...</option>');
        $descripcionInput.val('');

        if (productoId) {
            $.ajax({
                url: '/api/productos/' + productoId + '/terminados',
                method: 'GET',
                success: function(terminados) {
                    console.log("Terminados recibidos:", terminados);
                    $terminadoSelect.empty().append('<option value="">Seleccione terminado</option>');

                    if (terminados && terminados.length > 0) {
                        terminados.forEach(function(terminado) {
                            var medida = terminado.medidaTerminadoProducto || '0';
                            $terminadoSelect.append(
                                $('<option>', {
                                    value: terminado.id,
                                    'data-medida': medida,
                                    text: medida === '0' ? 'Sin medida' : medida
                                })
                            );
                        });
                        $terminadoSelect.prop('disabled', false);
                    } else {
                        $terminadoSelect.append('<option value="">No hay terminados disponibles</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar terminados:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);

                    $terminadoSelect.empty()
                        .append('<option value="">Error al cargar terminados</option>')
                        .prop('disabled', true);
                }
            });
        } else {
            $terminadoSelect.empty()
                .append('<option value="">Primero seleccione un producto</option>')
                .prop('disabled', true);
            $descripcionInput.val('');
        }
    });

    $(document).on('change', '.terminado-select', function() {
        var $this = $(this);
        var index = $this.data('index');
        var medida = $this.find('option:selected').data('medida');
        var $productoSelect = $('#producto-select-' + index);
        var productoNombre = $productoSelect.find('option:selected').data('nombre');
        var $descripcionInput = $('#descripcion-' + index);

        console.log("Terminado seleccionado - Medida:", medida, "Producto:", productoNombre);

        if (productoNombre) {
            var descripcion = productoNombre;
            if (medida && medida !== '0' && medida !== 'undefined') {
                descripcion += ' - ' + medida;
            }
            $descripcionInput.val(descripcion);
            console.log("Descripción generada:", descripcion);
        } else {
            $descripcionInput.val('');
        }
    });
});
</script>

</body>
</html>
