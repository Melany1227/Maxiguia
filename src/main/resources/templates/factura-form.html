<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Nueva Factura</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h1>Crear Nueva Factura</h1>

<form th:action="@{/facturas/guardar}" method="post" th:object="${factura}">

  <label>Fecha de Venta:</label>
  <input type="date" th:field="*{fechaVenta}" required><br>

  <label>Descripción de la Venta:</label>
  <input type="text" th:field="*{descripcionVenta}" required><br>

  <label>Usuario:</label>
  <select th:field="*{usuario.documento}">
    <option value="">Seleccione usuario</option>
    <option th:each="u : ${usuarios}" th:value="${u.documento}" th:text="${u.nombreCompleto}"></option>
  </select><br>

  <label>Empresa:</label>
  <select th:field="*{empresa.nitEmpresa}">
    <option value="">Seleccione empresa</option>
    <option th:each="e : ${empresas}" th:value="${e.nitEmpresa}" th:text="${e.nombre}"></option>
  </select><br>

  <label>Ciudad:</label>
  <select th:field="*{ciudad.id}">
    <option value="">Seleccione ciudad</option>
    <option th:each="c : ${ciudades}" th:value="${c.id}" th:text="${c.nombre}"></option>
  </select><br><br>

  <h3>Detalles de la Factura</h3>

  <div class="product-controls">
    <button type="button" id="decreaseProducts" onclick="adjustProducts(-1)">-</button>
    <span id="numProductsDisplay">1</span>
    <button type="button" id="increaseProducts" onclick="adjustProducts(1)">+</button>
    <input type="hidden" name="numProductos" id="numProductos" value="1"/>
  </div>

  <div id="productos-container">
    <div th:each="i : ${#numbers.sequence(0, numProductos != null ? numProductos - 1 : 0)}" class="producto-item">
    <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
      <label>Producto:</label>
      <select name="productoId" class="producto-select" th:data-index="${i}" th:id="'producto-select-' + ${i}">
        <option value="">Seleccione un producto</option>
        <option th:each="p : ${productos}"
                th:value="${p.id}"
                th:text="${p.nombre}"
                th:data-nombre="${p.nombre}"></option>
      </select><br><br>

      <label>Terminado:</label>
      <select name="terminadoId" class="terminado-select" th:data-index="${i}" th:id="'terminado-select-' + ${i}" disabled>
        <option value="">Primero seleccione un producto</option>
      </select><br><br>

      <label>Cantidad:</label>
      <input type="number" name="cantidad" class="cantidad-input" min="1" required th:id="'cantidad-' + ${i}" th:data-index="${i}"><br><br>

      <div class="form-row">
        <div class="form-group" style="flex: 1;">
          <label>Precio Unitario:</label>
          <input type="number" class="precio-unitario" step="0.01" readonly th:id="'precio-unitario-' + ${i}" th:data-index="${i}">
        </div>

        <div class="form-group" style="flex: 1;">
          <label>Valor Total:</label>
          <input type="number" name="valor" class="valor-total calculated-value" step="0.01" required readonly th:id="'valor-' + ${i}" th:data-index="${i}">
        </div>
      </div>

      <label>Descripción:</label>
      <input type="text" name="descripcion" class="descripcion-input" th:data-index="${i}" th:id="'descripcion-' + ${i}" readonly>
    </div>
  </div>

  <div style="margin-top: 20px; text-align: center;">
    <h3>Total Factura: $<span id="total-factura">0.00</span></h3>
  </div>

  <button type="submit">Guardar Factura</button>
</form>

<script>
function adjustProducts(change) {
    var currentNum = parseInt($('#numProductos').val());
    var newNum = Math.max(1, Math.min(10, currentNum + change));

    $('#numProductos').val(newNum);
    $('#numProductsDisplay').text(newNum);

    // Update the form to show/hide product sections
    $('.producto-item').each(function(index) {
        $(this).toggle(index < newNum);
    });
}

$(document).ready(function() {
    // Initialize with one product
    $('#numProductos').val(1);
    $('#numProductsDisplay').text(1);
    console.log("JavaScript cargado correctamente");

    $(document).on('change', '.producto-select', function() {
        var $this = $(this);
        var productoId = $this.val();
        var index = $this.data('index');
        var productoNombre = $this.find('option:selected').data('nombre');
        var $terminadoSelect = $('#terminado-select-' + index);
        var $descripcionInput = $('#descripcion-' + index);

        console.log("Producto seleccionado - ID:", productoId, "Index:", index, "Nombre:", productoNombre);

        $terminadoSelect.prop('disabled', true);
        $terminadoSelect.empty().append('<option value="">Cargando terminados...</option>');
        $descripcionInput.val('');

        if (productoId) {
            $.ajax({
                url: '/api/productos/' + productoId + '/terminados',
                method: 'GET',
                success: function(terminados) {
                    console.log("Terminados recibidos:", terminados);
                    $terminadoSelect.empty().append('<option value="">Seleccione terminado</option>');

                    if (terminados && terminados.length > 0) {
                        terminados.forEach(function(terminado) {
                            var medida = terminado.medidaTerminadoProducto || '0';
                            $terminadoSelect.append(
                                $('<option>', {
                                    value: terminado.id,
                                    'data-medida': medida,
                                    'data-precio': terminado.precioPublico,
                                    text: medida === '0' ? 'Sin medida' : medida
                                })
                            );
                        });
                        $terminadoSelect.prop('disabled', false);
                    } else {
                        $terminadoSelect.append('<option value="">No hay terminados disponibles</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar terminados:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);

                    $terminadoSelect.empty()
                        .append('<option value="">Error al cargar terminados</option>')
                        .prop('disabled', true);
                }
            });
        } else {
            $terminadoSelect.empty()
                .append('<option value="">Primero seleccione un producto</option>')
                .prop('disabled', true);
            $descripcionInput.val('');
        }
    });

    function calcularValorProducto(index) {
        var cantidad = parseFloat($('#cantidad-' + index).val()) || 0;
        var precioUnitario = parseFloat($('#precio-unitario-' + index).val()) || 0;
        var valorTotal = cantidad * precioUnitario;

        $('#valor-' + index).val(valorTotal.toFixed(2));
        calcularTotalFactura();
    }

    function calcularTotalFactura() {
        var total = 0;
        $('.valor-total').each(function() {
            var valor = parseFloat($(this).val()) || 0;
            total += valor;
        });

        $('#total-factura').text(total.toFixed(2));
    }

    $(document).on('change', '.terminado-select', function() {
        var $this = $(this);
        var index = $this.data('index');
        var medida = $this.find('option:selected').data('medida');
        var precio = $this.find('option:selected').data('precio');
        var $productoSelect = $('#producto-select-' + index);
        var productoNombre = $productoSelect.find('option:selected').data('nombre');
        var $descripcionInput = $('#descripcion-' + index);
        var $precioUnitario = $('#precio-unitario-' + index);

        if (productoNombre) {
            var descripcion = productoNombre;
            if (medida && medida !== '0' && medida !== 'undefined') {
                descripcion += ' - ' + medida;
            }
            $descripcionInput.val(descripcion);

            $precioUnitario.val(precio || 0);
            calcularValorProducto(index);
        } else {
            $descripcionInput.val('');
            $precioUnitario.val(0);
            calcularValorProducto(index);
        }
    });

    $(document).on('input change', '.cantidad-input', function() {
        var index = $(this).data('index');
        calcularValorProducto(index);
    });
});
</script>

</body>
</html>
